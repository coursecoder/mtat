version: "3.8"

# Moodle LMS + MariaDB for MTAT variant preview
# Usage:
#   docker compose up -d
#   Wait ~2 min for Moodle to initialize, then open http://localhost:8080
#   Admin login: admin / MoodleAdmin1!
#
# To stop (keeps data):   docker compose stop
# To reset everything:    docker compose down -v

services:
  mariadb:
    image: mariadb:10.11
    container_name: mtat-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: moodle
      MYSQL_USER: moodle
      MYSQL_PASSWORD: moodlepassword
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 10

  moodle:
    image: bitnami/moodle:4.3
    container_name: mtat-moodle
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      MOODLE_DATABASE_TYPE: mariadb
      MOODLE_DATABASE_HOST: mariadb
      MOODLE_DATABASE_PORT_NUMBER: 3306
      MOODLE_DATABASE_NAME: moodle
      MOODLE_DATABASE_USER: moodle
      MOODLE_DATABASE_PASSWORD: moodlepassword
      MOODLE_USERNAME: admin
      MOODLE_PASSWORD: MoodleAdmin1!
      MOODLE_EMAIL: admin@mtat.local
      MOODLE_SITE_NAME: "MTAT Course Preview"
      MOODLE_SKIP_BOOTSTRAP: "no"
      # Enable REST API web services
      MOODLE_ENABLE_HTTPS: "no"
    volumes:
      - moodle_data:/bitnami/moodle
      - moodledata_data:/bitnami/moodledata

volumes:
  mariadb_data:
  moodle_data:
  moodledata_data:
